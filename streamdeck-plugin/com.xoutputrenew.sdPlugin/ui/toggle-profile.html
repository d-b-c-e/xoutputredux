<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Toggle Profile</title>
    <link rel="stylesheet" href="https://sdk.elgato.com/pis/css/sdpi.css" />
  </head>
  <body>
    <div class="sdpi-wrapper">
      <div class="sdpi-heading">Toggle Profile Settings</div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">Profile</div>
        <select class="sdpi-item-value" id="profileName">
          <option value="">Select a profile...</option>
        </select>
      </div>

      <div class="sdpi-item">
        <div class="sdpi-item-label"></div>
        <button class="sdpi-item-value" id="refreshBtn">Refresh Profiles</button>
      </div>

      <div class="sdpi-info">
        Press the button to toggle the selected profile on or off. The button
        state will update to show whether the profile is currently running.
      </div>

      <div class="sdpi-item" id="errorMessage" style="display: none">
        <div class="sdpi-item-label">Error</div>
        <div class="sdpi-item-value" id="errorText" style="color: #ff6b6b"></div>
      </div>
    </div>

    <script>
      // Stream Deck Property Inspector connection
      let websocket = null;
      let uuid = null;
      let actionInfo = null;
      let settings = {};

      // Called by Stream Deck when Property Inspector is opened
      function connectElgatoStreamDeckSocket(
        inPort,
        inPropertyInspectorUUID,
        inRegisterEvent,
        inInfo,
        inActionInfo
      ) {
        uuid = inPropertyInspectorUUID;
        actionInfo = JSON.parse(inActionInfo);
        settings = actionInfo.payload.settings || {};

        // Connect to Stream Deck
        websocket = new WebSocket("ws://127.0.0.1:" + inPort);

        websocket.onopen = function () {
          // Register with Stream Deck
          websocket.send(
            JSON.stringify({
              event: inRegisterEvent,
              uuid: uuid,
            })
          );

          // Request profiles from plugin
          requestProfiles();
        };

        websocket.onmessage = function (evt) {
          const message = JSON.parse(evt.data);

          if (message.event === "sendToPropertyInspector") {
            handlePluginMessage(message.payload);
          }
        };

        // Initialize UI with current settings
        updateUI();
      }

      function handlePluginMessage(payload) {
        if (payload.event === "profilesList") {
          populateProfiles(payload.profiles);
        }
      }

      function requestProfiles() {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(
            JSON.stringify({
              event: "sendToPlugin",
              action: actionInfo.action,
              context: uuid,
              payload: { event: "getProfiles" },
            })
          );
        }
      }

      function populateProfiles(profiles) {
        const select = document.getElementById("profileName");
        const currentValue = settings.profileName || "";

        // Clear existing options except the first one
        while (select.options.length > 1) {
          select.remove(1);
        }

        // Add profiles
        profiles.forEach((profile) => {
          const option = document.createElement("option");
          option.value = profile.name;
          option.text = profile.name + (profile.isDefault ? " (Default)" : "");
          select.add(option);
        });

        // Restore selection
        select.value = currentValue;

        // Hide error if we got profiles
        if (profiles.length > 0) {
          hideError();
        }
      }

      function updateUI() {
        const select = document.getElementById("profileName");
        select.value = settings.profileName || "";
      }

      function saveSettings() {
        settings.profileName =
          document.getElementById("profileName").value || undefined;

        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(
            JSON.stringify({
              event: "setSettings",
              context: uuid,
              payload: settings,
            })
          );
        }
      }

      function showError(message) {
        document.getElementById("errorMessage").style.display = "flex";
        document.getElementById("errorText").textContent = message;
      }

      function hideError() {
        document.getElementById("errorMessage").style.display = "none";
      }

      // Event listeners
      document
        .getElementById("profileName")
        .addEventListener("change", saveSettings);
      document
        .getElementById("refreshBtn")
        .addEventListener("click", requestProfiles);
    </script>
  </body>
</html>
